# Day 22 Task

## 1. Configuring Jobs and Targets
 - Task: Set up a Prometheus server to monitor multiple services running on different nodes.
 - Deliverables:
     - Configure Prometheus with jobs for monitoring different services like web servers, databases, and system metrics.

```yml
# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]

  # webserver target setup
  - job_name: "nginx"
    static_configs:
      - targets: ["13.233.245.28:80"]

  # database target setup
  - job_name: "mysql"
    static_configs:
      - targets: ["13.233.245.28:9104"]

  # system metrics setup
  - job_name: "system_metrics"
    static_configs:
      - targets: ["13.233.245.28:9100"]

```

![alt text](<img/Screenshot from 2024-08-10 16-08-56.png>)

## 2. Using Exporters (Node Exporter)
 - Task: Use Node Exporter to monitor system-level metrics like CPU, memory, disk usage, and network statistics.
 - Deliverables:
     - Install and configure Node Exporter on all nodes.
     - Ensure Node Exporter metrics are being correctly scraped by Prometheus.

![alt text](<img/Screenshot from 2024-08-10 16-19-48.png>)

## 3. Hands-on Exercise: Setting Up Exporters
 - Task: Configure at least two different types of exporters (e.g., Node Exporter and MySQL Exporter) and integrate them with Prometheus.
 - Deliverables:
     - Demonstrate successful data collection from both exporters.
     - Create a basic Prometheus dashboard to visualize key metrics from these exporters.

![alt text](<img/Screenshot from 2024-08-10 16-21-43.png>)

## 4. Introduction to PromQL
 - Task: Learn and implement basic PromQL queries to extract meaningful data from the metrics collected.
 - Deliverables:
     - Write basic queries to retrieve metrics like average CPU usage, memory consumption, and disk I/O over time.

**Graph of average CPU usage** 
```sql
avg(rate(node_cpu_seconds_total{mode="user"}[5m])) by (instance)
```
![alt text](<img/Screenshot from 2024-08-10 16-30-09.png>) 

**Graph of memory consumptio**n
```sql
node_memory_MemTotal_bytes - node_memory_MemFree_bytes
```
![alt text](<img/Screenshot from 2024-08-10 16-31-13.png>)

**Graph of disk I/O over tim**e
```sql
avg(rate(node_disk_written_bytes_total[5m])) by (instance)
```
![alt text](<img/Screenshot from 2024-08-10 16-31-03.png>) 

## 5. Basic Queries (Selectors, Functions, Operators)
 - Task: Create PromQL queries using selectors, functions, and operators to filter and manipulate time-series data.
 - Deliverables:
     - Write PromQL queries to calculate the 95th percentile of CPU usage.
     - Use functions like rate(), increase(), and histogram_quantile() to perform more complex analysis.


## 6. Advanced Queries and Aggregations
 - Task: Perform advanced data aggregation using PromQL.
 - Deliverables:
     - Write queries to calculate the total memory usage across all nodes.
     - Aggregate data to find the maximum disk space usage among all nodes.

**Graph of total memory usage across all nodes**
```sql
sum(node_memory_MemTotal_bytes - node_memory_MemFree_bytes)
```
![alt text](<img/Screenshot from 2024-08-10 16-38-31.png>) 

**Graph of maximum disk space usage among all nodes**
```sql
max(node_filesystem_size_bytes - node_filesystem_free_bytes)
```
![alt text](<img/Screenshot from 2024-08-10 16-38-44.png>)


## 7. Configuring Alertmanager
 - Task: Set up Alertmanager to handle alerts generated by Prometheus.
 - Deliverables:
     - Configure Alertmanager with Prometheus.
     - Create routing rules to manage alert notifications based on severity and service type.

![alt text](<img/Screenshot from 2024-08-10 16-44-27.png>)

## 8. Writing Alerting Rules
 - Task: Write custom alerting rules in Prometheus to trigger alerts based on specific conditions.
 - Deliverables:
     - Create alerting rules for high CPU usage, memory leaks, and disk space running low.
     - Ensure alerts are correctly generated and sent to Alertmanager.

![alt text](<img/Screenshot from 2024-08-10 17-06-14.png>)

## 9. Setting Up Notification Channels (Email, Slack, etc.)
 - Task: Integrate Alertmanager with multiple notification channels and Slack.
 - Deliverables:
     - Set up Email notifications for critical alerts.
     - Integrate Slack for real-time alerts and notifications.

**Creating Prometheus Channel on Slack**
![alt text](<img/Screenshot from 2024-08-10 16-47-21.png>) 

**Adding Incoming webhooks**
![alt text](<img/Screenshot from 2024-08-10 16-47-52.png>) 
![alt text](<img/Screenshot from 2024-08-10 16-48-38.png>) 

**Webhook added**
![alt text](<img/Screenshot from 2024-08-10 16-49-49.png>)

**Setting up alertmanager.yml**
![alt text](<img/Screenshot from 2024-08-10 17-03-42.png>)

## 10. Hands-on Exercise: Creating Alerts
 - Task: Test the entire alerting pipeline by creating and triggering custom alerts.
 - Deliverables:
     - Simulate a scenario where a node exceeds 90% CPU usage and ensure alerts are triggered and sent to both Email and Slack.
     - Validate the alerts in both notification channels.

Alert recieved on Alert Manager and forwarder to slack
![alt text](<img/Screenshot from 2024-08-10 17-20-36.png>)

Alert shown in slack
![alt text](<img/Screenshot from 2024-08-10 17-23-58.png>)